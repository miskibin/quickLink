name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    env:
      Project_Path: quickLink/quickLink.csproj
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
        
    - name: Setup MSBuild.exe
      uses: microsoft/setup-msbuild@v2
      
    - name: Restore the application
      run: dotnet restore $env:Project_Path
      
    - name: Get version from tag
      id: get_version
      run: |
        $tag = "${{ github.ref_name }}"
        $version = $tag -replace '^v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
      shell: pwsh
      
    - name: Generate release notes from commits
      id: release_notes
      run: |
        # Get the previous tag
        $currentTag = "${{ github.ref_name }}"
        $previousTag = git describe --tags --abbrev=0 "$currentTag^" 2>$null
        
        if ($previousTag) {
          Write-Host "Generating release notes from $previousTag to $currentTag"
          echo "PREVIOUS_TAG=$previousTag" >> $env:GITHUB_OUTPUT
          
          # Get commit messages between tags
          $commits = git log "$previousTag..$currentTag" --pretty=format:"%s" --no-merges
          
          # Categorize commits
          $features = @()
          $fixes = @()
          $improvements = @()
          $other = @()
          
          foreach ($commit in $commits) {
            if ($commit -match '^feat(\(.+\))?:\s*(.+)') {
              $features += "- $($matches[2])"
            }
            elseif ($commit -match '^fix(\(.+\))?:\s*(.+)') {
              $fixes += "- $($matches[2])"
            }
            elseif ($commit -match '^(perf|refactor|improve)(\(.+\))?:\s*(.+)') {
              $improvements += "- $($matches[3])"
            }
            elseif ($commit -match '^(chore|docs|style|test)(\(.+\))?:') {
              # Skip these commits
            }
            else {
              # For commits without conventional format, add them as-is
              $other += "- $commit"
            }
          }
          
          # Build the release notes
          $notes = ""
          
          if ($features.Count -gt 0) {
            $notes += "### ‚ú® New Features`n"
            $notes += ($features -join "`n") + "`n`n"
          }
          
          if ($fixes.Count -gt 0) {
            $notes += "### üêõ Bug Fixes`n"
            $notes += ($fixes -join "`n") + "`n`n"
          }
          
          if ($improvements.Count -gt 0) {
            $notes += "### ‚ö° Improvements`n"
            $notes += ($improvements -join "`n") + "`n`n"
          }
          
          if ($other.Count -gt 0) {
            $notes += "### üìù Other Changes`n"
            $notes += ($other -join "`n") + "`n`n"
          }
          
          # If no categorized commits, just list all commits
          if ($notes -eq "") {
            $notes = "### üìù Changes`n"
            $notes += ($commits | ForEach-Object { "- $_" }) -join "`n"
            $notes += "`n`n"
          }
          
          # Save to output (escape for GitHub Actions)
          $notes = $notes -replace '%', '%25' -replace '\n', '%0A' -replace '\r', '%0D'
          echo "NOTES=$notes" >> $env:GITHUB_OUTPUT
        }
        else {
          Write-Host "No previous tag found, using default notes"
          echo "PREVIOUS_TAG=" >> $env:GITHUB_OUTPUT
          echo "NOTES=First release or no previous tags found.%0A%0A" >> $env:GITHUB_OUTPUT
        }
      shell: pwsh
      
    - name: Build x64
      run: |
        dotnet publish $env:Project_Path -c Release -r win-x64 -p:Platform=x64 -p:PublishSingleFile=true --self-contained
        
    - name: Create ZIP archive
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        Compress-Archive -Path "quickLink/bin/x64/Release/net8.0-windows10.0.19041.0/win-x64/publish/*" -DestinationPath "quickLink-$version-win-x64.zip"
      shell: pwsh
      
    - name: Generate checksums
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $hash = (Get-FileHash -Path "quickLink-$version-win-x64.zip" -Algorithm SHA256).Hash
        "$hash  quickLink-$version-win-x64.zip" | Out-File -FilePath "SHA256SUMS.txt" -Encoding utf8
      shell: pwsh
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: QuickLink ${{ steps.get_version.outputs.TAG }}
        body: |
          ## QuickLink ${{ steps.get_version.outputs.VERSION }}
          
          ${{ steps.release_notes.outputs.NOTES }}
          
          ### üì¶ Installation
          1. Download the appropriate ZIP file for your system
          2. Extract the archive
          3. Run `quickLink.exe`
          4. Configure your hotkey in Settings (default: Ctrl+Space)
          
          ### üíª Requirements
          - Windows 10 (19041 or later) or Windows 11
          - No additional runtime installation required (self-contained)
          
          ### üîê Checksums
          See `SHA256SUMS.txt` for file verification.
        files: |
          quickLink-${{ steps.get_version.outputs.VERSION }}-win-x64.zip
          SHA256SUMS.txt
        draft: false
        prerelease: false
        generate_release_notes: ${{ steps.release_notes.outputs.PREVIOUS_TAG == '' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
